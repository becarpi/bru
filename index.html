<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NexaCorp ‚Äî Missi√≥ Secreta</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600&display=swap');
:root{--gold:#FFD700;--red:#CC0000;--dark:#0a0a0f;--panel:#12121e;--accent:#7B2FBE;--cyan:#00f0ff}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--dark);color:#fff;font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:hidden;padding-bottom:64px}
.stars{position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse at center,#1a0a2e 0%,#0a0a0f 100%)}
.stars::before,.stars::after{content:'';position:absolute;inset:0;background-image:radial-gradient(1px 1px at 20% 30%,white,transparent),radial-gradient(1px 1px at 80% 10%,white,transparent),radial-gradient(1px 1px at 50% 60%,white,transparent),radial-gradient(1px 1px at 10% 80%,white,transparent),radial-gradient(1px 1px at 90% 50%,white,transparent),radial-gradient(2px 2px at 45% 45%,rgba(255,255,200,.8),transparent),radial-gradient(1px 1px at 75% 85%,white,transparent);background-size:400px 400px;animation:twinkle 4s infinite alternate}
.stars::after{background-size:300px 300px;animation-duration:6s;animation-delay:2s}
@keyframes twinkle{0%{opacity:.4}100%{opacity:1}}
.screen{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.hidden{display:none!important}

#intro{text-align:center}
.classified-banner{background:var(--red);color:#fff;font-family:'Orbitron',monospace;font-size:clamp(9px,1.8vw,12px);letter-spacing:5px;padding:7px 24px;border:2px solid #ff4444;margin-bottom:32px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.logo-gru{font-family:'Orbitron',monospace;font-size:clamp(10px,1.8vw,15px);color:#aaa;letter-spacing:8px;margin-bottom:7px}
.logo-title{font-family:'Orbitron',monospace;font-size:clamp(34px,8vw,86px);font-weight:900;background:linear-gradient(135deg,var(--gold) 0%,#ff8800 50%,var(--gold) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 28px rgba(255,200,0,.5));line-height:1;letter-spacing:4px}
.logo-sub{font-family:'Orbitron',monospace;font-size:clamp(8px,1.8vw,13px);color:var(--cyan);letter-spacing:10px;margin-top:7px}
.enc-display{background:rgba(123,47,190,.15);border:1px solid var(--accent);border-radius:8px;padding:14px 32px;margin:24px auto;max-width:560px;font-family:'Orbitron',monospace;font-size:clamp(16px,4vw,34px);color:var(--cyan);letter-spacing:8px;text-shadow:0 0 18px var(--cyan);animation:glitch 3s infinite}
@keyframes glitch{0%,90%,100%{text-shadow:0 0 18px var(--cyan)}92%{text-shadow:3px 0 18px #ff0080,-3px 0 18px var(--cyan)}94%{text-shadow:-3px 0 18px #ff0080,3px 0 18px var(--cyan)}}
.intro-msg{font-size:clamp(13px,2vw,16px);color:#ccc;max-width:560px;line-height:1.75;margin:14px auto;font-style:italic}
.intro-msg strong{color:var(--gold);font-style:normal}

.btn{font-family:'Orbitron',monospace;font-size:clamp(10px,1.6vw,13px);font-weight:700;letter-spacing:2px;padding:13px 32px;border:none;border-radius:4px;cursor:pointer;transition:all .25s;margin:5px}
.btn-primary{background:linear-gradient(135deg,var(--gold),#ff8800);color:#000}
.btn-primary:hover{transform:scale(1.05);box-shadow:0 0 26px rgba(255,200,0,.6)}
.btn-secondary{background:transparent;color:var(--cyan);border:2px solid var(--cyan)}
.btn-secondary:hover{background:rgba(0,240,255,.1);transform:scale(1.05)}
.btn-danger{background:linear-gradient(135deg,#cc0000,#880000);color:#fff}
.btn-danger:hover{transform:scale(1.05)}
.btn-sm{padding:8px 18px;font-size:10px}

#group-select{text-align:center}
.screen-title{font-family:'Orbitron',monospace;font-size:clamp(15px,3vw,26px);color:var(--gold);margin-bottom:7px}
.screen-sub{color:#aaa;font-size:14px;margin-bottom:32px}
.groups-grid{display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:32px}
.group-card{background:var(--panel);border:2px solid #333;border-radius:12px;padding:26px 32px;cursor:pointer;transition:all .3s;text-align:center;min-width:140px}
.group-card:hover{border-color:var(--gold);box-shadow:0 0 26px rgba(255,200,0,.3);transform:translateY(-4px)}
.g-icon{font-size:42px;margin-bottom:7px}
.g-name{font-family:'Orbitron',monospace;font-size:17px;font-weight:700;color:var(--gold)}
.g-pos{font-size:11px;color:#888;margin-top:3px}

#game{padding:20px}
.game-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:9px}
.game-title{font-family:'Orbitron',monospace;font-size:clamp(12px,2.3vw,19px);color:var(--gold)}
.game-info{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.badge{background:var(--panel);border:1px solid #444;border-radius:20px;padding:4px 12px;font-size:11px;color:#ccc}
.badge span{color:var(--gold);font-weight:700}
.legend{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;margin:7px 0;font-size:11px;color:#888}
.legend-item{display:flex;align-items:center;gap:3px}
.legend-dot{width:10px;height:10px;border-radius:3px}
.board-wrap{overflow-x:auto}
.board{display:grid;grid-template-columns:repeat(9,1fr);gap:3px;max-width:880px;margin:0 auto 14px;min-width:450px}
.cell{aspect-ratio:1;border-radius:7px;border:2px solid #333;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;position:relative;background:var(--panel)}
.cell:hover{transform:scale(1.06);z-index:10}
.cell.current{border-color:var(--gold)!important;box-shadow:0 0 16px rgba(255,200,0,.6);background:rgba(255,200,0,.15)!important;animation:bounce .6s infinite alternate}
@keyframes bounce{0%{transform:scale(1)}100%{transform:scale(1.08)}}
.cell.visited{border-color:#3a3a3a;opacity:.6}
.cell.s-roll{background:rgba(0,200,100,.15);border-color:#00c864}
.cell.s-stop{background:rgba(200,0,0,.15);border-color:#cc0000}
.cell.s-swap{background:rgba(123,47,190,.25);border-color:var(--accent)}
.cell.s-start{background:rgba(0,240,255,.1);border-color:var(--cyan)}
.cell.s-end{background:rgba(255,200,0,.2);border-color:var(--gold)}
.cell-num{font-family:'Orbitron',monospace;font-weight:700;color:#888;font-size:.8em}
.cell.current .cell-num,.cell.s-end .cell-num{color:var(--gold)}
.cell-icon{font-size:1.3em;line-height:1}
.cell-letter{font-family:'Orbitron',monospace;font-size:.76em;color:var(--cyan);margin-top:1px}
.pawn{position:absolute;top:2px;right:2px;width:13px;height:13px;border-radius:50%;border:2px solid #fff;font-size:7px;display:flex;align-items:center;justify-content:center;font-weight:700;z-index:5}
.pawn-1{background:#e74c3c}.pawn-2{background:#3498db}.pawn-3{background:#2ecc71}
.dice-area{display:flex;align-items:center;justify-content:center;gap:18px;margin:14px 0;flex-wrap:wrap}
.dice{width:66px;height:66px;background:#fff;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 4px 16px rgba(0,0,0,.5);cursor:pointer;user-select:none}
.dice.rolling{animation:roll .4s ease}
@keyframes roll{0%{transform:rotate(0) scale(1)}25%{transform:rotate(90deg) scale(1.2)}50%{transform:rotate(180deg) scale(.9)}75%{transform:rotate(270deg) scale(1.1)}100%{transform:rotate(360deg) scale(1)}}
.letters-area{background:var(--panel);border:1px solid #333;border-radius:10px;padding:12px;margin:12px auto;max-width:880px}
.letters-title{font-family:'Orbitron',monospace;font-size:10px;color:#666;letter-spacing:3px;margin-bottom:8px}
.letters-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.l-chip{background:rgba(123,47,190,.3);border:1px solid var(--accent);border-radius:6px;padding:5px 10px;font-family:'Orbitron',monospace;font-size:12px;color:#fff;display:flex;flex-direction:column;align-items:center;gap:1px}
.l-chip .pl{font-size:16px;color:var(--gold);font-weight:700}
.l-chip .en{font-size:11px;color:var(--cyan)}

/* ALPHABET GATE */
#alpha-gate{text-align:center}
.pw-box{background:var(--panel);border:2px solid var(--accent);border-radius:14px;padding:28px;max-width:370px;width:100%;text-align:center;box-shadow:0 0 44px rgba(123,47,190,.4)}
.pw-box h2{font-family:'Orbitron',monospace;color:var(--gold);margin-bottom:16px;font-size:19px}
.pw-input{background:#0d0d18;border:2px solid #444;border-radius:8px;color:#fff;font-family:'Orbitron',monospace;font-size:19px;padding:11px 16px;width:100%;text-align:center;outline:none;letter-spacing:6px;margin-bottom:12px;transition:border-color .2s}
.pw-input:focus{border-color:var(--cyan)}
.pw-error{color:#ff4444;font-size:12px;min-height:16px;margin-bottom:9px}

/* ALPHABET */
#alphabet-screen{text-align:center}
.alpha-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:6px;max-width:660px;margin:16px auto}
.alpha-cell{background:var(--panel);border:1px solid #222;border-radius:6px;padding:8px 4px;text-align:center;transition:all .3s}
.alpha-cell.unlocked{border-color:var(--gold);background:rgba(255,200,0,.08)}
.alpha-enc{font-family:'Orbitron',monospace;font-size:19px}
.alpha-plain{font-size:17px;font-weight:700;margin-top:2px}
.alpha-cell.unlocked .alpha-enc{color:var(--cyan)}
.alpha-cell.unlocked .alpha-plain{color:var(--gold)}
.alpha-cell:not(.unlocked) .alpha-enc,.alpha-cell:not(.unlocked) .alpha-plain{color:#252525}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--panel);border:2px solid var(--accent);border-radius:16px;padding:28px;max-width:440px;width:100%;text-align:center;box-shadow:0 0 50px rgba(123,47,190,.4)}
.modal h2{font-family:'Orbitron',monospace;font-size:clamp(14px,2.8vw,21px);color:var(--gold);margin-bottom:7px}
.modal-enc{font-family:'Orbitron',monospace;font-size:36px;color:var(--cyan);margin:12px 0;text-shadow:0 0 16px var(--cyan);letter-spacing:8px}
.modal-letter{font-family:'Orbitron',monospace;font-size:72px;color:var(--gold);font-weight:900;filter:drop-shadow(0 0 16px rgba(255,200,0,.7));margin:5px 0;animation:popIn .4s ease}
@keyframes popIn{0%{transform:scale(0);opacity:0}60%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
.modal-desc{color:#aaa;font-size:13px;line-height:1.6;margin-bottom:16px}
.modal-special{background:rgba(0,0,0,.4);border-radius:8px;padding:11px;margin:9px 0;font-size:13px;color:#eee}
.modal-special .icon{font-size:28px;margin-bottom:4px}

/* WIN */
#win-screen{text-align:center}
.win-title{font-family:'Orbitron',monospace;font-size:clamp(24px,5.5vw,54px);font-weight:900;color:var(--gold);margin-bottom:16px;animation:glow 2s infinite alternate}
@keyframes glow{0%{filter:drop-shadow(0 0 8px rgba(255,200,0,.5))}100%{filter:drop-shadow(0 0 34px rgba(255,200,0,1))}}

/* POSTA EN COM√ö screen */
#poolscreen{text-align:center;padding:30px 20px}
.pool-title{font-family:'Orbitron',monospace;font-size:clamp(16px,3.5vw,28px);color:var(--gold);margin-bottom:6px}
.pool-sub{color:#aaa;font-size:14px;margin-bottom:28px}
.pool-groups{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-bottom:28px}
.pool-group{background:var(--panel);border:2px solid #333;border-radius:12px;padding:20px;min-width:180px;text-align:center}
.pool-group-title{font-family:'Orbitron',monospace;font-size:14px;color:var(--gold);margin-bottom:12px}
.pool-chips{display:flex;flex-wrap:wrap;gap:5px;justify-content:center}
.pool-chip{background:rgba(123,47,190,.3);border:1px solid var(--accent);border-radius:5px;padding:5px 9px;font-family:'Orbitron',monospace;font-size:13px;color:var(--cyan)}
.decode-area{background:var(--panel);border:1px solid #333;border-radius:10px;padding:20px;max-width:600px;margin:0 auto 24px}
.decode-title{font-family:'Orbitron',monospace;font-size:11px;color:#666;letter-spacing:3px;margin-bottom:14px}
.decode-slots{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:16px}
.slot{display:flex;flex-direction:column;align-items:center;gap:4px}
.slot-sym{font-family:'Orbitron',monospace;font-size:22px;color:var(--cyan);text-shadow:0 0 12px var(--cyan)}
.slot-input{width:44px;height:44px;background:#0d0d18;border:2px solid #444;border-radius:7px;color:var(--gold);font-family:'Orbitron',monospace;font-size:20px;font-weight:700;text-align:center;outline:none;transition:border-color .2s;text-transform:uppercase}
.slot-input:focus{border-color:var(--cyan)}
.slot-input.correct{border-color:#00c864;background:rgba(0,200,100,.1);color:#00c864}
.slot-input.wrong{border-color:#cc0000;background:rgba(200,0,0,.08)}
.check-result{font-family:'Orbitron',monospace;font-size:16px;min-height:24px;margin-top:8px;letter-spacing:3px}

.nav-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,.96);border-top:1px solid #1e1e1e;display:flex;justify-content:center;gap:6px;padding:8px;z-index:50}
.nav-btn{font-family:'Orbitron',monospace;font-size:10px;letter-spacing:1px;padding:7px 12px;background:transparent;border:1px solid #252525;border-radius:6px;color:#666;cursor:pointer;transition:all .2s}
.nav-btn.active,.nav-btn:hover{color:var(--gold);border-color:var(--gold);background:rgba(255,200,0,.07)}
</style>
</head>
<body>
<div class="stars"></div>

<!-- INTRO -->
<div id="intro" class="screen">
  <div class="classified-banner">‚ö† ARXIU CLASSIFICAT ‚Äî ACC√âS RESTRINGIT ‚ö†</div>
  <div>
    <div class="logo-gru">UNIVERS DE BRU</div>
    <div class="logo-title">‚óá‚ú¶‚ó¨‚óà‚óÜ‚¨£‚óë‚óÆ</div>
    <div class="logo-sub">OPERACI√ì DECODIFICA</div>
  </div>
  <div class="enc-display" id="enc-display">‚óÜ ‚ú¶ ‚¨° ‚ú¶ ‚óÜ ‚ú¶ ‚¨¢ ‚ú¶ ‚óÜ</div>
  <p class="intro-msg">Les filles de <strong>Bru</strong> han estat segrestades.<br>L'√∫nic rastre √©s un missatge encriptat deixat per una organitzaci√≥ misteriosa.<br>Necessitem la vostra ajuda per <strong>desxifrar el nom de la corporaci√≥ villana</strong><br>i rescatar-les abans que sigui massa tard.</p>
  <p class="intro-msg" style="color:#666;font-size:11px">‚ö† El cocodril us portar√† les primeres pistes. Cada prova que supereu us revelar√† una lletra de l'alfabet secret. <strong style="color:#999">El temps corre.</strong></p>
  <div style="margin-top:26px;display:flex;gap:9px;flex-wrap:wrap;justify-content:center">
    <button class="btn btn-primary" onclick="goGroupSelect()">üéØ INICIAR MISSI√ì</button>
    <button class="btn btn-secondary" onclick="openAlphabetGate()">üî° ALFABET SECRET</button>
    <button class="btn btn-secondary" id="btn-pool" onclick="goPool()" style="display:none">üîì POSAR EN COM√ö</button>
  </div>
</div>

<!-- GROUP SELECT -->
<div id="group-select" class="screen hidden">
  <div class="screen-title">SELECCIONA EL GRUP</div>
  <div class="screen-sub">Cada grup t√© el seu propi progr√©s</div>
  <div class="groups-grid">
    <div class="group-card" onclick="startGame(1)"><div class="g-icon">üî¥</div><div class="g-name">GRUP 1</div><div class="g-pos">Casella <span id="p1-pos">0</span></div></div>
    <div class="group-card" onclick="startGame(2)"><div class="g-icon">üîµ</div><div class="g-name">GRUP 2</div><div class="g-pos">Casella <span id="p2-pos">0</span></div></div>
    <div class="group-card" onclick="startGame(3)"><div class="g-icon">üü¢</div><div class="g-name">GRUP 3</div><div class="g-pos">Casella <span id="p3-pos">0</span></div></div>
  </div>
  <button class="btn btn-secondary btn-sm" onclick="goScreen('intro')">‚Üê ENRERE</button>
</div>

<!-- GAME -->
<div id="game" class="screen hidden">
  <div class="game-header">
    <div class="game-title" id="game-title">GRUP 1 ‚Äî TAULER</div>
    <div class="game-info">
      <div class="badge">Casella: <span id="cur-pos">0</span>/36</div>
      <div class="badge">Lletres: <span id="cur-letters">0</span></div>
      <button class="btn btn-secondary btn-sm" onclick="goGroupSelect()">‚Üê GRUPS</button>
    </div>
  </div>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#00c864"></div>Tira de nou</div>
    <div class="legend-item"><div class="legend-dot" style="background:#cc0000"></div>Stop!</div>
    <div class="legend-item"><div class="legend-dot" style="background:#7B2FBE"></div>Canvi fitxa</div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(0,240,255,.4)"></div>Sortida</div>
    <div class="legend-item"><div class="legend-dot" style="background:rgba(255,200,0,.4)"></div>Meta</div>
  </div>
  <div class="board-wrap"><div class="board" id="board"></div></div>
  <div class="dice-area">
    <div class="dice" id="dice" onclick="rollDice()">üé≤</div>
    <div>
      <div style="font-family:'Orbitron',monospace;font-size:11px;color:#555;margin-bottom:4px">FES CLIC PER LLAN√áAR</div>
      <div id="roll-result" style="font-family:'Orbitron',monospace;font-size:19px;color:var(--gold);min-height:24px"></div>
    </div>
  </div>
  <div class="letters-area">
    <div class="letters-title">LLETRES DESENCRIPTADES</div>
    <div class="letters-row" id="letters-row"><span style="color:#3a3a3a;font-size:13px">Encara no teniu cap lletra...</span></div>
  </div>
</div>

<!-- ALPHABET GATE -->
<div id="alpha-gate" class="screen hidden">
  <div class="pw-box">
    <h2>üîê ACC√âS ALFABET</h2>
    <p style="color:#aaa;font-size:13px;margin-bottom:18px">Introdueix la contrasenya d'agent per veure l'alfabet complet, o selecciona el teu grup</p>
    <input class="pw-input" id="pw-input" type="password" maxlength="20" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')checkPw()">
    <div class="pw-error" id="pw-error"></div>
    <button class="btn btn-primary btn-sm" onclick="checkPw()" style="width:100%;margin-bottom:11px">ACCEDIR COM A AGENT</button>
    <div style="display:flex;gap:7px;justify-content:center;flex-wrap:wrap">
      <button class="btn btn-secondary btn-sm" onclick="goAlphaGroup(1)">üî¥ GRUP 1</button>
      <button class="btn btn-secondary btn-sm" onclick="goAlphaGroup(2)">üîµ GRUP 2</button>
      <button class="btn btn-secondary btn-sm" onclick="goAlphaGroup(3)">üü¢ GRUP 3</button>
    </div>
    <button class="btn btn-sm" style="color:#444;border:1px solid #1e1e1e;background:transparent;margin-top:10px" onclick="goBack()">‚Üê ENRERE</button>
  </div>
</div>

<!-- ALPHABET -->
<div id="alphabet-screen" class="screen hidden">
  <div class="screen-title">ALFABET SECRET</div>
  <div class="screen-sub" id="alpha-sub">Lletres descobertes</div>
  <div class="alpha-grid" id="alpha-grid"></div>
  <button class="btn btn-secondary btn-sm" style="margin-top:16px" onclick="openAlphabetGate()">‚Üê ENRERE</button>
</div>

<!-- POSTA EN COM√ö -->
<div id="poolscreen" class="screen hidden">
  <div class="pool-title">üîì POSTA EN COM√ö</div>
  <div class="pool-sub">Uniu les lletres dels tres grups per desxifrar el missatge secret</div>

  <div class="pool-groups" id="pool-groups"></div>

  <div class="decode-area">
    <div class="decode-title">MISSATGE ENCRIPTAT ‚Äî DESXIFREU-LO</div>
    <div class="decode-slots" id="decode-slots"></div>
    <button class="btn btn-primary btn-sm" onclick="checkDecode()">VERIFICAR ‚Üí</button>
    <div class="check-result" id="check-result"></div>
  </div>

  <button class="btn btn-secondary btn-sm" onclick="goScreen('intro')">‚Üê ENRERE</button>
</div>

<!-- WIN -->
<div id="win-screen" class="screen hidden">
  <div style="font-size:36px;margin-bottom:9px">üéâüèÜüéä</div>
  <div class="win-title">MISSI√ì COMPLETADA!</div>
  <p style="color:#aaa;font-size:17px;margin-bottom:7px">La corporaci√≥ villana es diu:</p>
  <div style="font-family:'Orbitron',monospace;font-size:clamp(22px,5vw,46px);color:var(--red);letter-spacing:8px;margin:16px 0;text-shadow:0 0 26px rgba(200,0,0,.8)">‚óá‚ú¶‚ó¨‚óà‚óÜ‚¨£‚óë‚óÆ</div>
  <p style="color:#ccc;font-size:14px;max-width:460px;text-align:center;margin:16px auto;line-height:1.7">Gr√†cies a vosaltres, hem descobert l'organitzaci√≥ que va segrestar les filles de Bru. NEXACORP<br><strong style="color:var(--gold)">El cocodril ara podr√† proseguir amb l'investigaci√≥ per poder ajudar al Bru quan torni‚≠ê</strong></p>
  <div style="font-size:34px;margin:9px">ü¶∏‚Äç‚ôÇÔ∏è</div>
  <div style="margin-top:24px;display:flex;gap:9px;flex-wrap:wrap;justify-content:center">
    <button class="btn btn-primary" onclick="goScreen('intro')">üè† INICI</button>
    <button class="btn btn-secondary" onclick="goGroupSelect()">üéÆ GRUPS</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay hidden" id="modal-overlay">
  <div class="modal">
    <h2 id="modal-title"></h2>
    <div id="modal-content"></div>
    <button class="btn btn-primary btn-sm" onclick="closeModal()" style="margin-top:13px">CONTINUAR ‚Üí</button>
  </div>
</div>

<!-- NAV -->
<div class="nav-bar" id="nav-bar" style="display:none">
  <button class="nav-btn" id="nav-board" onclick="navGame()">üéØ TAULER</button>
  <button class="nav-btn" id="nav-alpha" onclick="openAlphabetGate()">üî° ALFABET</button>
  <button class="nav-btn" id="nav-pool" onclick="goPool()">üîì EN COM√ö</button>
  <button class="nav-btn" onclick="goScreen('intro')">üè† INICI</button>
</div>

<script>
// ===== ALPHABET =====
const ALPHA={A:'‚óà',B:'‚¨°',C:'‚óÜ',D:'‚üÅ',E:'‚ú¶',F:'‚¨¢',G:'‚óâ',H:'‚üê',I:'‚ñ≤',J:'‚¨ü',K:'‚óê',L:'‚¨†',M:'‚úß',N:'‚óá',O:'‚¨£',P:'‚óÆ',Q:'‚¨¶',R:'‚óë',S:'‚ü°',T:'‚ñ∑',U:'‚¨ß',V:'‚óä',W:'‚ü†',X:'‚ó¨',Y:'‚ü¢',Z:'‚ó≠'};
const MONITOR_PW='nexacorp2024';

// TARGET = NEXACORP ‚Äî but NEVER shown directly, only its symbols
const TARGET='NEXACORP';
const TARGET_SYMS=TARGET.split('').map(l=>ALPHA[l]); // ['‚óá','‚ú¶','‚ó¨','‚óà','‚óÜ','‚¨£','‚óë','‚óÆ']

// ===== BOARD =====
// Each group has different letter assignments so together they cover all 8 letters of NEXACORP
// Grup 1: N, E, X, A  (caselles amb lletra)
// Grup 2: C, O, R, P
// Grup 3: mix to ensure full coverage in all cases
// But since groups play independently, we assign ALL letters to ALL boards
// ensuring every group gets at least one of each (they pool at the end)
const SPECIAL={1:'start',4:'roll',10:'stop',19:'roll',24:'stop',29:'swap',36:'end'};

// Per grup, les lletres de les seves casilles
// Grup 1 cobreix: N E X A  |  Grup 2: C O R P  |  Grup 3: N X C R (les que falten per completar)
// Per√≤ el joc √©s que EN CONJUNT els tres grups tinguin totes 8 lletres.
// Soluci√≥: cada grup t√© un subconjunt √∫nic + algunes compartides perqu√® sempre surtin totes.
const GROUP_LETTERS = {
  // Grup 1: N, E, X, A  + pistes falses B i D (menys freq√ºents)
  1: {2:'N',3:'E',5:'X',6:'A',7:'N',8:'E',9:'X',11:'A',12:'B',13:'E',14:'X',15:'A',16:'N',17:'E',18:'X',20:'A',21:'N',22:'D',23:'X',25:'A',26:'N',27:'E',28:'X',30:'A',31:'N',32:'E',33:'X',34:'A',35:'N'},
  // Grup 2: C, O, R, P  + pistes falses F i G (menys freq√ºents)
  2: {2:'C',3:'O',5:'R',6:'P',7:'C',8:'O',9:'R',11:'P',12:'C',13:'F',14:'R',15:'P',16:'C',17:'O',18:'R',20:'P',21:'C',22:'O',23:'G',25:'P',26:'C',27:'O',28:'R',30:'P',31:'C',32:'O',33:'R',34:'P',35:'C'},
  // Grup 3: mix de totes + pistes falses M i S (menys freq√ºents)
  3: {2:'N',3:'X',5:'C',6:'R',7:'E',8:'A',9:'O',11:'P',12:'M',13:'X',14:'C',15:'R',16:'E',17:'A',18:'O',20:'P',21:'N',22:'X',23:'C',25:'S',26:'E',27:'A',28:'O',30:'P',31:'N',32:'X',33:'C',34:'R',35:'E'}
};

function snakeOrder(){const o=[];for(let r=0;r<4;r++){const row=[];for(let c=0;c<9;c++)row.push(r*9+c+1);if(r%2)row.reverse();o.push(...row);}return o;}
const CELL_ORDER=snakeOrder();

// ===== STATE =====
const S={cur:null,groups:{1:{pos:0,letters:[],skips:0},2:{pos:0,letters:[],skips:0},3:{pos:0,letters:[],skips:0}}};

// ===== SCREENS =====
const SCREENS=['intro','group-select','game','alpha-gate','alphabet-screen','poolscreen','win-screen'];
function goScreen(id){
  SCREENS.forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  const showNav=['game','alphabet-screen','alpha-gate','poolscreen'].includes(id);
  document.getElementById('nav-bar').style.display=showNav?'flex':'none';
  document.getElementById('nav-board')?.classList.toggle('active',id==='game');
  document.getElementById('nav-alpha')?.classList.toggle('active',id==='alphabet-screen'||id==='alpha-gate');
  document.getElementById('nav-pool')?.classList.toggle('active',id==='poolscreen');
}
function goGroupSelect(){updateGroupPos();goScreen('group-select');}
function updateGroupPos(){[1,2,3].forEach(g=>document.getElementById(`p${g}-pos`).textContent=S.groups[g].pos);}
function navGame(){if(S.cur)goScreen('game');else goGroupSelect();}
function goBack(){if(S.cur)goScreen('game');else goScreen('intro');}

// ===== ALPHABET GATE =====
function openAlphabetGate(){document.getElementById('pw-input').value='';document.getElementById('pw-error').textContent='';goScreen('alpha-gate');}
function checkPw(){const v=document.getElementById('pw-input').value;if(v===MONITOR_PW)renderAlphabet(null);else document.getElementById('pw-error').textContent='Contrasenya incorrecta. Prova amb el teu grup.';}
function goAlphaGroup(g){renderAlphabet(g);}
function renderAlphabet(g){
  const unlocked=g?new Set(S.groups[g].letters.map(l=>l.plain)):null;
  document.getElementById('alpha-sub').textContent=g?`Grup ${g} ‚Äî Lletres descobertes: ${S.groups[g].letters.length}`:'üîì VISTA AGENT ‚Äî Alfabet complet';
  const grid=document.getElementById('alpha-grid');grid.innerHTML='';
  Object.entries(ALPHA).forEach(([letter,sym])=>{
    const ok=!g||unlocked.has(letter);
    const div=document.createElement('div');div.className='alpha-cell'+(ok?' unlocked':'');
    div.innerHTML=`<div class="alpha-enc">${ok?sym:'?'}</div><div class="alpha-plain">${ok?letter:'?'}</div>`;
    grid.appendChild(div);
  });
  goScreen('alphabet-screen');
}

// ===== POSTA EN COM√ö =====
function goPool(){
  renderPool();goScreen('poolscreen');
}
function renderPool(){
  // Groups section
  const pg=document.getElementById('pool-groups');pg.innerHTML='';
  const colors={1:'#e74c3c',2:'#3498db',3:'#2ecc71'};
  [1,2,3].forEach(g=>{
    const div=document.createElement('div');div.className='pool-group';
    div.style.borderColor=colors[g];
    const chips=S.groups[g].letters.length
      ?S.groups[g].letters.map(l=>`<div class="pool-chip">${l.enc}</div>`).join('')
      :`<span style="color:#444;font-size:12px">Cap lletra encara</span>`;
    div.innerHTML=`<div class="pool-group-title" style="color:${colors[g]}">GRUP ${g}</div><div class="pool-chips">${chips}</div>`;
    pg.appendChild(div);
  });
  // Decode slots ‚Äî show symbols of TARGET, inputs blank
  const slots=document.getElementById('decode-slots');slots.innerHTML='';
  TARGET_SYMS.forEach((sym,i)=>{
    const div=document.createElement('div');div.className='slot';
    div.innerHTML=`<div class="slot-sym">${sym}</div><input class="slot-input" id="slot-${i}" maxlength="1" placeholder="?" oninput="this.value=this.value.toUpperCase()">`;
    slots.appendChild(div);
  });
  document.getElementById('check-result').textContent='';
}
function checkDecode(){
  let allCorrect=true;
  TARGET.split('').forEach((letter,i)=>{
    const inp=document.getElementById(`slot-${i}`);
    const val=(inp.value||'').toUpperCase();
    if(val===letter){inp.className='slot-input correct';}
    else{inp.className='slot-input wrong';allCorrect=false;}
  });
  const res=document.getElementById('check-result');
  if(allCorrect){res.style.color='#00c864';res.textContent='‚úì CORRECTE!';setTimeout(()=>goScreen('win-screen'),1200);}
  else{res.style.color='#cc0000';res.textContent='‚úó ALGUNA LLETRA FALLA...';}
}

// ===== GAME =====
function startGame(g){S.cur=g;document.getElementById('game-title').textContent=`GRUP ${g} ‚Äî TAULER`;renderBoard();updateLetters();goScreen('game');}

function renderBoard(){
  const board=document.getElementById('board');board.innerHTML='';
  const g=S.groups[S.cur];const CL=GROUP_LETTERS[S.cur];
  const others={};[1,2,3].forEach(n=>{if(n!==S.cur&&S.groups[n].pos>0){const p=S.groups[n].pos;others[p]=(others[p]||[]).concat(n);}});
  CELL_ORDER.forEach(num=>{
    const cell=document.createElement('div');cell.className='cell';cell.id=`cell-${num}`;
    const sp=SPECIAL[num];
    if(sp==='start')cell.classList.add('s-start');
    else if(sp==='end')cell.classList.add('s-end');
    else if(sp==='roll')cell.classList.add('s-roll');
    else if(sp==='stop')cell.classList.add('s-stop');
    else if(sp==='swap')cell.classList.add('s-swap');
    if(g.pos>0&&num<g.pos)cell.classList.add('visited');
    if(num===g.pos)cell.classList.add('current');
    const icon=sp==='roll'?'üé≤':sp==='stop'?'üõë':sp==='swap'?'üîÄ':sp==='start'?'üèÅ':sp==='end'?'üèÜ':'';
    const lt=CL[num];const lDisp=lt?ALPHA[lt]:'';
    cell.innerHTML=`<div class="cell-num">${num}</div>${icon?`<div class="cell-icon">${icon}</div>`:''}${lDisp?`<div class="cell-letter">${lDisp}</div>`:''}`;
    if(others[num])others[num].forEach(n=>{const p=document.createElement('div');p.className=`pawn pawn-${n}`;p.textContent=n;cell.appendChild(p);});
    if(num===g.pos){const p=document.createElement('div');p.className=`pawn pawn-${S.cur}`;p.textContent=S.cur;p.style.cssText='top:auto;bottom:2px;right:2px';cell.appendChild(p);}
    cell.onclick=()=>showCellInfo(num);
    board.appendChild(cell);
  });
  document.getElementById('cur-pos').textContent=g.pos;
}

function rollDice(){
  const g=S.groups[S.cur];
  if(g.skips>0){g.skips--;showModal('üõë STOP!',`<div class="modal-special"><div class="icon">üõë</div>Heu de passar un torn aturat!<br>Torns restants: <strong>${g.skips}</strong></div>`);return;}
  const dice=document.getElementById('dice');
  dice.classList.add('rolling');setTimeout(()=>dice.classList.remove('rolling'),400);
  const roll=Math.floor(Math.random()*6)+1;
  dice.textContent=['‚öÄ','‚öÅ','‚öÇ','‚öÉ','‚öÑ','‚öÖ'][roll-1];
  document.getElementById('roll-result').textContent=`Has tret un ${roll}`;
  setTimeout(()=>movePlayer(roll),500);
}

function movePlayer(steps){
  const g=S.groups[S.cur];const CL=GROUP_LETTERS[S.cur];
  let np=g.pos+steps;if(np>36)np=36-(np-36);
  g.pos=np;
  const lt=CL[np];
  if(lt&&!g.letters.find(l=>l.plain===lt))g.letters.push({plain:lt,enc:ALPHA[lt]});
  renderBoard();updateLetters();
  setTimeout(()=>{const el=document.getElementById(`cell-${np}`);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});},100);
  if(np===36){
    // Unlock "posta en com√∫" button everywhere
    document.getElementById('btn-pool').style.display='inline-block';
    setTimeout(()=>{
      showModal('üèÜ HEU ARRIBAT A LA META!',`
        <p class="modal-desc">Heu completat el vostre recorregut!<br>Ara cal que poseu en com√∫ les lletres amb els altres grups.</p>
        <button class="btn btn-primary" onclick="closeModal();goPool()">üîì POSAR EN COM√ö ‚Üí</button>
      `);
    },600);
    return;
  }
  const sp=SPECIAL[np];
  const ltBlock=lt?`<p style="margin-top:12px;color:#aaa;font-size:13px">Heu rebut un s√≠mbol secret:</p><div class="modal-enc">${ALPHA[lt]}</div>`:'';
  if(sp==='roll'){showModal('üé≤ TIRA DE NOU!',`<div class="modal-special"><div class="icon">üé≤</div><strong>Casella ${np} ‚Äî Tira de nou!</strong><br>Torneu a llan√ßar immediatament!</div>${ltBlock}`);return;}
  if(sp==='stop'){g.skips=1;showModal('üõë STOP!',`<div class="modal-special"><div class="icon">üõë</div><strong>Casella ${np} ‚Äî Stop!</strong><br>Perdeu el proper torn!</div>${ltBlock}`);return;}
  if(sp==='swap'){
    showModal('üîÄ CANVI DE FITXA!',`<div class="modal-special"><div class="icon">üîÄ</div><strong>Casella ${np} ‚Äî Canvi de fitxa!</strong><br>Canvieu posici√≥ amb un altre grup!</div><div style="display:flex;gap:7px;flex-wrap:wrap;justify-content:center;margin-top:11px">${[1,2,3].filter(n=>n!==S.cur).map(n=>`<button class="btn btn-danger btn-sm" onclick="doSwap(${n});closeModal()">Canviar amb Grup ${n}<br><small>(cas. ${S.groups[n].pos})</small></button>`).join('')}</div>${ltBlock}`);
    return;
  }
  if(lt){
    showModal(`Casella ${np}`,`
      <p class="modal-desc">Heu superat la prova!<br>El s√≠mbol encriptat √©s:</p>
      <div class="modal-enc">${ALPHA[lt]}</div>
      <div id="reveal-wrap">
        <button class="btn btn-primary" onclick="revealLetter('${lt}','${ALPHA[lt]}')" style="font-size:18px;letter-spacing:3px;padding:14px 36px">
          üëÅ REVELAR LLETRA
        </button>
      </div>
      <p style="color:#555;font-size:11px;margin-top:8px">Guardeu-la! La necessitareu per desxifrar el missatge.</p>
    `);
  }
}

function revealLetter(lt,enc){
  const w=document.getElementById('reveal-wrap');
  if(w)w.innerHTML=`<div class="modal-letter">${lt}</div><p style="color:var(--cyan);font-family:'Orbitron',monospace;font-size:12px;margin-top:3px">= ${enc}</p>`;
}

function doSwap(other){[S.groups[S.cur].pos,S.groups[other].pos]=[S.groups[other].pos,S.groups[S.cur].pos];renderBoard();}

function showCellInfo(num){
  const sp=SPECIAL[num];const lt=GROUP_LETTERS[S.cur]?.[num];
  const titles={start:'üèÅ SORTIDA',end:'üèÜ META',roll:`üé≤ Casella ${num}`,stop:`üõë Casella ${num}`,swap:`üîÄ Casella ${num}`};
  const bodies={start:`<p class="modal-desc">Aqu√≠ comen√ßa l'aventura!</p>`,end:`<p class="modal-desc">L'objectiu final!</p>`,roll:`<div class="modal-special"><div class="icon">üé≤</div>Si caieu aqu√≠, torneu a llan√ßar!</div>`,stop:`<div class="modal-special"><div class="icon">üõë</div>Si caieu aqu√≠, perdeu un torn!</div>`,swap:`<div class="modal-special"><div class="icon">üîÄ</div>Si caieu aqu√≠, canvieu posici√≥ amb un altre grup!</div>`};
  if(sp)showModal(titles[sp],bodies[sp]);
  else if(lt)showModal(`Casella ${num}`,`<div class="modal-enc">${ALPHA[lt]}</div><p class="modal-desc">S√≠mbol secret d'aquesta casella.</p>`);
  else showModal(`Casella ${num}`,`<p class="modal-desc">Casella normal ‚Äî supereu la prova!</p>`);
}

function updateLetters(){
  const g=S.groups[S.cur];
  document.getElementById('cur-letters').textContent=g.letters.length;
  const row=document.getElementById('letters-row');
  if(!g.letters.length){row.innerHTML='<span style="color:#3a3a3a;font-size:12px">Encara no teniu cap lletra...</span>';return;}
  row.innerHTML='';
  [...g.letters].sort((a,b)=>a.plain.localeCompare(b.plain)).forEach(l=>{
    const c=document.createElement('div');c.className='l-chip';
    c.innerHTML=`<div class="pl">${l.plain}</div><div class="en">${l.enc}</div>`;
    row.appendChild(c);
  });
}

function showModal(t,c){document.getElementById('modal-title').textContent=t;document.getElementById('modal-content').innerHTML=c;document.getElementById('modal-overlay').classList.remove('hidden');}
function closeModal(){document.getElementById('modal-overlay').classList.add('hidden');}

// Intro anim
const encWords=['‚óÜ ‚ú¶ ‚¨° ‚ú¶ ‚óÜ ‚ú¶ ‚¨¢ ‚ú¶ ‚óÜ','‚óá ‚ú¶ ‚ó¨ ‚óà ‚óÜ ‚¨£ ‚óë ‚óÆ','‚ñ≤ ‚óâ ‚óë ‚óë ‚¨£ ‚óë ‚ñ∑ ‚ú¶','‚óá ‚ú¶ ‚ó¨ ‚óà ‚óÜ ‚¨£ ‚óë ‚óÆ'];
let ei=0;setInterval(()=>{const el=document.getElementById('enc-display');if(el){el.textContent=encWords[ei%encWords.length];ei++;}},2000);
</script>
</body>
</html>
